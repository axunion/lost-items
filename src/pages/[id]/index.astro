---
import { ClipboardList, PlusCircle, Share2 } from "lucide-solid";
import AppHeader from "~/components/ui/AppHeader.astro";
import { Button } from "~/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "~/components/ui/card";
import Layout from "../../layouts/Layout.astro";

const { id = "" } = Astro.params;
---

<Layout title="Dashboard">
  <AppHeader title="Dashboard" showBack backUrl="/" />

  <main class="px-4 py-6 space-y-6">
    <div class="text-center space-y-2">
      <p class="text-xs font-medium text-muted-foreground uppercase tracking-wide">List ID</p>
      <div class="inline-block px-3 py-1.5 bg-secondary rounded-md">
        <code class="font-mono text-sm font-medium">{id}</code>
      </div>
    </div>

    <div class="space-y-3">
      <a href={`/${id}/register`} class="block">
        <Card class="hover:bg-secondary/50">
          <CardHeader class="pb-2">
            <CardTitle class="flex items-center gap-2 text-base">
              <PlusCircle class="size-5" />
              Register Item
            </CardTitle>
          </CardHeader>
          <CardContent class="pt-0">
            <p class="text-sm text-muted-foreground">
              Add a new found item to this list.
            </p>
          </CardContent>
        </Card>
      </a>

      <a href={`/${id}/list`} class="block">
        <Card class="hover:bg-secondary/50">
          <CardHeader class="pb-2">
            <CardTitle class="flex items-center gap-2 text-base">
              <ClipboardList class="size-5" />
              View Public List
            </CardTitle>
          </CardHeader>
          <CardContent class="pt-0">
            <p class="text-sm text-muted-foreground">
              See what visitors see.
            </p>
          </CardContent>
        </Card>
      </a>
    </div>

    <Card>
      <CardHeader class="pb-2">
        <CardTitle class="flex items-center gap-2 text-base">
          <Share2 class="size-4" />
          Share List
        </CardTitle>
      </CardHeader>
      <CardContent class="pt-0">
        <div class="flex items-center gap-2 bg-secondary p-2 rounded-md">
          <code class="text-xs flex-1 overflow-hidden text-ellipsis whitespace-nowrap text-muted-foreground font-mono">
            {Astro.url.origin}/{id}/list
          </code>
          <Button
            size="sm"
            id="copy-btn"
            variant="secondary"
            class="shrink-0"
            data-url={`${Astro.url.origin}/${id}/list`}
          >
            Copy
          </Button>
        </div>
      </CardContent>
    </Card>
  </main>
</Layout>

<script define:vars={{ id }}>
  try {
    const key = "lost-items-history";
    const history = JSON.parse(localStorage.getItem(key) || "[]");
    const filtered = history.filter(item => item.id !== id);
    filtered.push({ id, timestamp: Date.now() });
    if (filtered.length > 10) filtered.shift();
    localStorage.setItem(key, JSON.stringify(filtered));
  } catch (e) {
    console.error("Failed to save history", e);
  }
</script>

<script>
  const copyBtn = document.getElementById('copy-btn');
  if (copyBtn) {
    copyBtn.addEventListener('click', () => {
      const url = copyBtn.getAttribute('data-url');
      if (url) {
        navigator.clipboard.writeText(url).then(() => {
          const originalText = copyBtn.innerText;
          copyBtn.innerText = 'Copied!';
          setTimeout(() => {
            copyBtn.innerText = originalText;
          }, 2000);
        });
      }
    });
  }
</script>
