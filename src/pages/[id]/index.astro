---
import {
	ClipboardList,
	Copy,
	ExternalLink,
	Pencil,
	PlusCircle,
	Trash2,
} from "lucide-solid";
import AppHeader from "~/components/ui/AppHeader.astro";
import { Button } from "~/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "~/components/ui/card";
import Layout from "../../layouts/Layout.astro";

const { id = "" } = Astro.params;
---

<Layout title="Dashboard">
  <AppHeader title="Loading..." showBack backUrl="/">
    <button
      slot="right"
      id="edit-name-btn"
      class="hidden p-2 -mr-2 text-muted-foreground hover:text-foreground transition-colors"
      title="Edit Room Name"
    >
      <Pencil class="size-4" />
    </button>
  </AppHeader>

  <main class="px-4 py-6 space-y-6" id="dashboard-container" data-id={id}>
    <div class="space-y-6">
      <!-- Register Item Card -->
      <Card class="rounded-xl border-border/50">
        <CardHeader class="pb-4">
          <CardTitle class="flex items-center gap-2 text-lg font-bold">
            <PlusCircle class="size-6 text-primary" />
            Register Item
          </CardTitle>
        </CardHeader>
        <CardContent class="space-y-4">
          <div class="space-y-3">
            <div class="flex items-center gap-2 bg-secondary/50 pl-4 pr-1 rounded-xl border border-input/50 h-14">
              <code class="text-xs flex-1 overflow-hidden text-ellipsis whitespace-nowrap text-muted-foreground/80 font-mono">
                {Astro.url.origin}/{id}/register
              </code>
              <Button
                size="icon"
                variant="ghost"
                class="shrink-0 copy-btn h-12 w-12 rounded-lg"
                data-url={`${Astro.url.origin}/${id}/register`}
                title="Copy"
              >
                <ClipboardList class="size-5" />
              </Button>
            </div>
            <a href={`/${id}/register`} target="_blank" rel="noopener noreferrer" class="block">
              <Button class="w-full h-14 justify-between pl-4 pr-4 font-bold rounded-xl transition-all active:scale-[0.98]" variant="outline">
                <span class="text-base">Registration</span>
                <ExternalLink class="size-6 text-primary" />
              </Button>
            </a>
          </div>
        </CardContent>
      </Card>

      <!-- Public List Card -->
      <Card class="rounded-xl border-border/50">
        <CardHeader class="pb-4">
          <CardTitle class="flex items-center gap-2 text-lg font-bold">
            <ClipboardList class="size-6 text-primary" />
            Public Room
          </CardTitle>
        </CardHeader>
        <CardContent class="space-y-4">
          <div class="space-y-3">
            <div class="flex items-center gap-2 bg-secondary/50 pl-4 pr-1 rounded-xl border border-input/50 h-14">
              <code class="text-xs flex-1 overflow-hidden text-ellipsis whitespace-nowrap text-muted-foreground/80 font-mono">
                {Astro.url.origin}/{id}/room
              </code>
              <Button
                size="icon"
                variant="ghost"
                class="shrink-0 copy-btn h-12 w-12 rounded-lg"
                data-url={`${Astro.url.origin}/${id}/room`}
                title="Copy"
              >
                <ClipboardList class="size-5" />
              </Button>
            </div>
            <a href={`/${id}/room`} target="_blank" rel="noopener noreferrer" class="block">
              <Button class="w-full h-14 justify-between pl-4 pr-4 font-bold rounded-xl transition-all active:scale-[0.98]" variant="outline">
                <span class="text-base">Public View</span>
                <ExternalLink class="size-6 text-primary" />
              </Button>
            </a>
          </div>
        </CardContent>
      </Card>

      <!-- Danger Zone -->
      <div id="danger-zone" class="hidden pt-8 space-y-4">
        <div class="flex items-center gap-4 px-1">
          <div class="h-px flex-1 bg-destructive/20"></div>
          <span class="text-[10px] font-bold text-destructive/60 uppercase tracking-[0.2em]">Danger Zone</span>
          <div class="h-px flex-1 bg-destructive/20"></div>
        </div>
        <Button
          id="delete-list-btn"
          variant="destructive"
          class="w-full h-14 font-bold text-lg flex items-center justify-center gap-2 rounded-xl transition-all active:scale-[0.98] shadow-sm shadow-destructive/20"
        >
          <Trash2 class="size-6" />
          Delete Room
        </Button>
      </div>
    </div>
  </main>
</Layout>

<script>
  import { getHistory, updateHistory, removeFromHistory } from "~/lib/history";

  try {
    const container = document.getElementById('dashboard-container');
    const id = container?.dataset.id;
    if (!id) throw new Error("ID not found in container");

    const history = getHistory();
    const currentItem = history.find(item => item.id === id);
    const listName = currentItem?.name || "Untitled Room";

    const headerTitle = document.getElementById('header-title');
    const editBtn = document.getElementById('edit-name-btn');
    const dangerZone = document.getElementById('danger-zone');
    const deleteBtn = document.getElementById('delete-list-btn');

    if (headerTitle) {
      headerTitle.innerText = listName;
    }
    document.title = `${listName} | Dashboard`;

    if (currentItem?.isOwner) {
      if (editBtn) editBtn.classList.remove('hidden');
      if (dangerZone) dangerZone.classList.remove('hidden');
    }

    // Refresh timestamp
    updateHistory(id, { timestamp: Date.now() });

    // Edit Name logic
    editBtn?.addEventListener('click', () => {
      const newName = prompt("Enter new room name:", listName);
      if (newName && newName !== listName) {
        updateHistory(id, { name: newName });
        if (headerTitle) headerTitle.innerText = newName;
        document.title = `${newName} | Dashboard`;
      }
    });

    // Delete logic
    deleteBtn?.addEventListener('click', () => {
      if (confirm(`Are you sure you want to delete "${listName}"? This action cannot be undone.`)) {
        removeFromHistory(id);
        window.location.href = '/';
      }
    });
  } catch (e) {
    console.error("Failed to handle dashboard logic", e);
  }
</script>

<script>
  // Copy button logic
  const copyBtns = document.querySelectorAll('.copy-btn');
  copyBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const url = btn.getAttribute('data-url');
      if (url) {
        navigator.clipboard.writeText(url).then(() => {
          const originalHTML = btn.innerHTML;
          btn.innerHTML = '<span class="text-xs font-bold text-primary">Copied!</span>';
          setTimeout(() => {
            btn.innerHTML = originalHTML;
          }, 2000);
        });
      }
    });
  });
</script>
