---
import {
	ClipboardList,
	ExternalLink,
	Pencil,
	PlusCircle,
	Trash2,
} from "lucide-solid";
import AppHeader from "~/components/ui/AppHeader.astro";
import { Button } from "~/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "~/components/ui/card";
import Layout from "../../layouts/Layout.astro";

const { id = "" } = Astro.params;
---

<Layout title="Dashboard">
  <AppHeader title="Loading..." showBack backUrl="/">
    <button
      slot="right"
      id="edit-name-btn"
      class="hidden p-2 -mr-2 text-muted-foreground hover:text-foreground transition-colors"
      title="Edit List Name"
    >
      <Pencil class="size-4" />
    </button>
  </AppHeader>

  <main class="px-4 py-6 space-y-8" id="dashboard-container" data-id={id}>
    <div class="space-y-6">
      <!-- Register Item Card -->
      <Card>
        <CardHeader class="pb-2">
          <CardTitle class="flex items-center gap-2 text-base">
            <PlusCircle class="size-5 text-primary" />
            Register Item
          </CardTitle>
        </CardHeader>
        <CardContent class="space-y-4">
          <p class="text-sm text-muted-foreground">
            Allow others to register items to this list.
          </p>
          <div class="space-y-2">
            <div class="flex items-center gap-2 bg-secondary p-2 rounded-md border border-input/50">
              <code class="text-xs flex-1 overflow-hidden text-ellipsis whitespace-nowrap text-muted-foreground font-mono">
                {Astro.url.origin}/{id}/register
              </code>
              <Button
                size="sm"
                variant="secondary"
                class="shrink-0 h-8 copy-btn"
                data-url={`${Astro.url.origin}/${id}/register`}
              >
                Copy
              </Button>
            </div>
            <a href={`/${id}/register`} target="_blank" rel="noopener noreferrer" class="block">
              <Button class="w-full h-11 justify-between px-4 font-medium" variant="outline">
                <span>Open Registration Page</span>
                <ExternalLink class="size-4" />
              </Button>
            </a>
          </div>
        </CardContent>
      </Card>

      <!-- Public List Card -->
      <Card>
        <CardHeader class="pb-2">
          <CardTitle class="flex items-center gap-2 text-base">
            <ClipboardList class="size-5 text-primary" />
            Public Items List
          </CardTitle>
        </CardHeader>
        <CardContent class="space-y-4">
          <p class="text-sm text-muted-foreground">
            Allow others to view items in this list.
          </p>
          <div class="space-y-2">
            <div class="flex items-center gap-2 bg-secondary p-2 rounded-md border border-input/50">
              <code class="text-xs flex-1 overflow-hidden text-ellipsis whitespace-nowrap text-muted-foreground font-mono">
                {Astro.url.origin}/{id}/list
              </code>
              <Button
                size="sm"
                variant="secondary"
                class="shrink-0 h-8 copy-btn"
                data-url={`${Astro.url.origin}/${id}/list`}
              >
                Copy
              </Button>
            </div>
            <a href={`/${id}/list`} target="_blank" rel="noopener noreferrer" class="block">
              <Button class="w-full h-11 justify-between px-4 font-medium" variant="outline">
                <span>Open Public List</span>
                <ExternalLink class="size-4" />
              </Button>
            </a>
          </div>
        </CardContent>
      </Card>

      <!-- Danger Zone -->
      <div id="danger-zone" class="hidden pt-8 space-y-4">
        <div class="flex items-center gap-2 px-1">
          <div class="h-px flex-1 bg-border/50"></div>
          <span class="text-xs font-medium text-muted-foreground uppercase tracking-wider">Danger Zone</span>
          <div class="h-px flex-1 bg-border/50"></div>
        </div>
        <Button
          id="delete-list-btn"
          variant="destructive"
          class="w-full h-11 font-medium"
        >
          <Trash2 class="size-4 mr-2" />
          Delete This List
        </Button>
      </div>
    </div>
  </main>
</Layout>

<script>
  import { getHistory, updateHistory, removeFromHistory } from "~/lib/history";

  try {
    const container = document.getElementById('dashboard-container');
    const id = container?.dataset.id;
    if (!id) throw new Error("ID not found in container");

    const history = getHistory();
    const currentItem = history.find(item => item.id === id);
    const listName = currentItem?.name || "Untitled List";

    const headerTitle = document.getElementById('header-title');
    const editBtn = document.getElementById('edit-name-btn');
    const dangerZone = document.getElementById('danger-zone');
    const deleteBtn = document.getElementById('delete-list-btn');

    if (headerTitle) {
      headerTitle.innerText = listName;
    }
    document.title = `${listName} | Dashboard`;

    if (currentItem?.isOwner) {
      if (editBtn) editBtn.classList.remove('hidden');
      if (dangerZone) dangerZone.classList.remove('hidden');
    }

    // Refresh timestamp
    updateHistory(id, { timestamp: Date.now() });

    // Edit Name logic
    editBtn?.addEventListener('click', () => {
      const newName = prompt("Enter new list name:", listName);
      if (newName && newName !== listName) {
        updateHistory(id, { name: newName });
        if (headerTitle) headerTitle.innerText = newName;
        document.title = `${newName} | Dashboard`;
      }
    });

    // Delete logic
    deleteBtn?.addEventListener('click', () => {
      if (confirm(`Are you sure you want to delete "${listName}"? This action cannot be undone.`)) {
        removeFromHistory(id);
        window.location.href = '/';
      }
    });
  } catch (e) {
    console.error("Failed to handle dashboard logic", e);
  }
</script>

<script>
  // Copy button logic
  const copyBtns = document.querySelectorAll('.copy-btn');
  copyBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const url = btn.getAttribute('data-url');
      if (url) {
        navigator.clipboard.writeText(url).then(() => {
          const originalText = (btn as HTMLElement).innerText;
          (btn as HTMLElement).innerText = 'Copied!';
          setTimeout(() => {
            (btn as HTMLElement).innerText = originalText;
          }, 2000);
        });
      }
    });
  });
</script>
